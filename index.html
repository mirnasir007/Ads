<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .table-header { background-color: #f3f4f6; }
        .summary-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal { transition: opacity 0.25s ease; }
        #notification-toast { z-index: 1000; transition: right 0.4s ease-in-out; }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="loader" class="loader"></div>
    <div id="dashboard-content" class="container mx-auto p-4 md:p-8 hidden">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6 text-center">Ads Management Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-gray-200"><h2 class="text-lg font-semibold text-blue-600 mb-2">Total Loaded (USD)</h2><p id="total-usd" class="text-3xl font-bold text-gray-900">$0.00</p></div>
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-gray-200"><h2 class="text-lg font-semibold text-red-600 mb-2">Total Ad Cost (USD)</h2><p id="total-cost" class="text-3xl font-bold text-gray-900">$0.00</p></div>
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-gray-200"><h2 class="text-lg font-semibold text-green-600 mb-2">Available Balance (USD)</h2><p id="available-usd" class="text-3xl font-bold text-gray-900">$0.00</p></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200"><div class="flex flex-wrap justify-between items-center mb-4 gap-2"><h2 class="text-2xl font-bold">Load Amount</h2><div class="flex items-center gap-4"><p id="current-rate-display" class="text-sm text-gray-600 font-medium">Loading rate...</p><div class="flex items-center gap-2"><input type="number" step="0.01" id="custom-rate-input" placeholder="Set BDT Rate" class="w-28 p-1 border rounded-md text-sm focus:ring-2 focus:ring-blue-500"><button id="set-rate-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md font-semibold">Set</button></div></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="table-header"><tr><th class="p-3 font-semibold">Date</th><th class="p-3 font-semibold">Recharges (Tk)</th><th class="p-3 font-semibold">USD</th></tr></thead><tbody id="load-amount-body"></tbody></table></div><button onclick="openModal('load-modal')" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Add Load Amount</button></div>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200"><div class="flex flex-wrap items-center justify-between gap-4 mb-4"><h2 class="text-2xl font-bold">Ads Details</h2><div class="flex items-center gap-2 bg-gray-100 p-2 rounded-lg"><label for="report-from-date" class="text-sm font-medium text-gray-700">From:</label><input type="date" id="report-from-date" class="p-1 border rounded-md text-sm"><label for="report-to-date" class="text-sm font-medium text-gray-700">To:</label><input type="date" id="report-to-date" class="p-1 border rounded-md text-sm"><button id="download-report-btn" class="bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 text-sm font-semibold">Download Excel</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="table-header"><tr><th class="p-3 font-semibold">Ad Name</th><th class="p-3 font-semibold">Daily Budget</th><th class="p-3 font-semibold">Duration</th><th class="p-3 font-semibold">Total Cost</th><th class="p-3 font-semibold text-right">Action</th></tr></thead><tbody id="ads-details-body"></tbody></table></div><button onclick="openModal('ad-modal')" class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Add Ad</button></div>
        </div>
    </div>
    <div id="load-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Add New Load Amount</h2><form id="load-form"><div class="mb-4"><label for="load-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label><input type="date" id="load-date" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="recharge-tk" class="block text-sm font-medium text-gray-700 mb-1">Recharge Amount (Tk)</label><input type="number" id="recharge-tk" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label for="usd-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (USD)</label><input type="number" step="0.01" id="usd-amount" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly></div><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('load-modal')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button><button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Add Entry</button></div></form></div></div>
    <div id="ad-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-6">Add New Ad</h2><form id="ad-form"><div class="mb-4"><label for="ad-name" class="block text-sm font-medium text-gray-700 mb-1">Ad Name</label><input type="text" id="ad-name" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label><input type="date" id="start-date" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label><input type="date" id="end-date" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label for="daily-budget" class="block text-sm font-medium text-gray-700 mb-1">Daily Budget (USD)</label><input type="number" step="0.01" id="daily-budget" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('ad-modal')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">Add Ad</button></div></form></div></div>
    <div id="edit-ad-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Edit Ad End Date</h2><form id="edit-ad-form"><div class="mb-4"><p class="block text-sm font-medium text-gray-700 mb-1">Ad Name</p><p id="edit-ad-name" class="w-full p-2 bg-gray-100 rounded-lg"></p></div><div class="mb-6"><label for="edit-end-date" class="block text-sm font-medium text-gray-700 mb-1">New End Date</label><input type="date" id="edit-end-date" class="w-full p-2 border border-gray-300 rounded-lg" required></div><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('edit-ad-modal')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button><button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">Update Date</button></div></form></div></div>
    <div id="notification-toast" class="fixed top-5 right-[-100%] bg-red-600 text-white py-3 px-5 rounded-lg shadow-xl"><p id="notification-message"></p></div>
    
    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbympzZ0JyGA6dMpdtVaDUPnrx5IV2Je_huDt4KpsfwBS2nSTu74lKXF9tRaPPSmPKT9-g/exec'; // এখানে আপনার কপি করা URL টি পেস্ট করুন
        const EXCHANGE_RATE_API_KEY = '8f5d338f843ffe034cb0fe6b'; // আপনার ExchangeRate-API Key
        const FALLBACK_RATE = 121.0;
        // --------------------

        // Global variables
        let loadAmounts = [];
        let adsDetails = [];
        let BDT_PER_USD = FALLBACK_RATE;

        // DOM Elements
        const loader = document.getElementById('loader');
        const dashboardContent = document.getElementById('dashboard-content');
        const loadAmountBody = document.getElementById('load-amount-body');
        const adsDetailsBody = document.getElementById('ads-details-body');
        const totalUsdEl = document.getElementById('total-usd');
        const totalCostEl = document.getElementById('total-cost');
        const availableUsdEl = document.getElementById('available-usd');
        const loadForm = document.getElementById('load-form');
        const adForm = document.getElementById('ad-form');
        const editAdForm = document.getElementById('edit-ad-form');
        const rechargeTkInput = document.getElementById('recharge-tk');
        const usdAmountInput = document.getElementById('usd-amount');
        const rateDisplay = document.getElementById('current-rate-display');
        const customRateInput = document.getElementById('custom-rate-input');
        const setRateBtn = document.getElementById('set-rate-btn');
        const downloadReportBtn = document.getElementById('download-report-btn');

        // --- Core Functions ---
        async function postData(action, payload) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                return result;
            } catch (error) {
                showNotification(`Error: ${error.message}`);
                throw error;
            }
        }
        
        async function fetchInitialData() {
            setLoading(true);
            try {
                const [rateResponse, sheetResponse] = await Promise.all([
                    fetch(`https://v6.exchangerate-api.com/v6/${EXCHANGE_RATE_API_KEY}/latest/USD`),
                    fetch(WEB_APP_URL)
                ]);

                // Process Rate Data
                if(rateResponse.ok) {
                    const rateData = await rateResponse.json();
                    if(rateData.result === 'success' && rateData.conversion_rates.BDT) {
                        BDT_PER_USD = rateData.conversion_rates.BDT;
                        updateRateDisplay(BDT_PER_USD);
                    } else {
                         updateRateDisplay(FALLBACK_RATE, false, true);
                    }
                } else {
                    updateRateDisplay(FALLBACK_RATE, false, true);
                }

                // Process Sheet Data
                if(sheetResponse.ok) {
                    const sheetData = await sheetResponse.json();
                    if(sheetData.success) {
                        loadAmounts = sheetData.loadAmounts.map(row => ({ date: row[0], recharges: parseFloat(row[1]) || 0, usd: parseFloat(row[2]) || 0 }));
                        adsDetails = sheetData.adsDetails.map(row => ({ adsName: row[0], startDate: row[1], endDate: row[2], dailyBudget: parseFloat(row[3]) || 0 }));
                        renderAll();
                        showNotification("App is ready!", false);
                    } else {
                        throw new Error(sheetData.message);
                    }
                } else {
                     throw new Error("Failed to fetch data from Google Sheet API.");
                }

            } catch (error) {
                showNotification(`Critical Error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // --- Render Functions ---
        function renderLoadAmounts() { /* No changes */ }
        function renderAdsDetails() { /* No changes */ }
        function calculateSummary() { /* No changes */ }
        function renderAll() { renderLoadAmounts(); renderAdsDetails(); calculateSummary(); }
        
        // --- Utility Functions ---
        const formatCurrency = (amount) => `$${(amount || 0).toFixed(2)}`;
        const formatDate = (dateString) => dayjs(dateString).format('DD-MMM-YYYY');
        const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        function openModal(modalId) { /* No changes */ }
        function openEditAdModal(adName) { /* No changes */ }
        function updateRateDisplay(rate, isCustom = false, isFallback = false) { /* No changes */ }
        function showNotification(message, isError = true) { /* No changes */ }
        function setLoading(isLoading) {
            loader.style.display = isLoading ? 'block' : 'none';
            dashboardContent.classList.toggle('hidden', isLoading);
        }

        // --- Event Listeners ---
        setRateBtn.addEventListener('click', () => { /* No changes */ });
        rechargeTkInput.addEventListener('input', () => { /* No changes */ });
        downloadReportBtn.addEventListener('click', () => { /* No changes */ });

        loadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newLoad = { date: document.getElementById('load-date').value, recharges: parseFloat(rechargeTkInput.value), usd: parseFloat(usdAmountInput.value) };
            if (isNaN(newLoad.usd) || newLoad.usd <= 0) { showNotification("Please enter a valid recharge amount."); return; }
            
            setLoading(true);
            try {
                const result = await postData('addLoadEntry', newLoad);
                loadAmounts.push(newLoad);
                renderAll();
                showNotification(result.message, false);
                closeModal('load-modal');
                loadForm.reset();
            } catch (error) {
                // Notification is already shown in postData
            } finally {
                setLoading(false);
            }
        });

        adForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newAd = { adsName: document.getElementById('ad-name').value, startDate: document.getElementById('start-date').value, endDate: document.getElementById('end-date').value, dailyBudget: parseFloat(document.getElementById('daily-budget').value) };
            if (dayjs(newAd.endDate).isBefore(dayjs(newAd.startDate))) { showNotification("End date cannot be before start date."); return; }
            
            setLoading(true);
            try {
                const result = await postData('addAdEntry', newAd);
                adsDetails.push(newAd);
                renderAll();
                showNotification(result.message, false);
                closeModal('ad-modal');
                adForm.reset();
            } catch (error) {
                 // Notification is already shown in postData
            } finally {
                setLoading(false);
            }
        });

        editAdForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                adName: document.getElementById('edit-ad-name').textContent,
                newEndDate: document.getElementById('edit-end-date').value
            };
            
            setLoading(true);
            try {
                const result = await postData('editAdEndDate', payload);
                const adIndex = adsDetails.findIndex(ad => ad.adsName === payload.adName);
                if (adIndex !== -1) adsDetails[adIndex].endDate = payload.newEndDate;
                renderAll();
                showNotification(result.message, false);
                closeModal('edit-ad-modal');
            } catch (error) {
                // Notification is already shown in postData
            } finally {
                setLoading(false);
            }
        });

        // App Initialization
        document.addEventListener('DOMContentLoaded', () => {
            if (WEB_APP_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
                setLoading(false);
                showNotification("Please set your Web App URL in the index.html file.");
                return;
            }
            const today = dayjs().format('YYYY-MM-DD');
            document.getElementById('report-from-date').value = today;
            document.getElementById('report-to-date').value = today;
            fetchInitialData();
        });

        // Re-pasting unchanged functions for completeness
        function renderLoadAmounts() { loadAmountBody.innerHTML = ''; if (loadAmounts.length === 0) { loadAmountBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-500">No load amounts added yet.</td></tr>`; } else { loadAmounts.forEach(item => { const row = `<tr class="border-b border-gray-200 hover:bg-gray-50"><td class="p-3">${formatDate(item.date)}</td><td class="p-3">${item.recharges.toLocaleString('en-IN')}</td><td class="p-3 font-medium">${formatCurrency(item.usd)}</td></tr>`; loadAmountBody.innerHTML += row; }); } }
        function renderAdsDetails() { adsDetailsBody.innerHTML = ''; if (adsDetails.length === 0) { adsDetailsBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No ads added yet.</td></tr>`; } else { adsDetails.forEach(ad => { const durationDays = dayjs(ad.endDate).diff(dayjs(ad.startDate), 'day') + 1; const totalCost = durationDays * ad.dailyBudget; const row = `<tr class="border-b border-gray-200 hover:bg-gray-50"><td class="p-3 font-medium">${ad.adsName}</td><td class="p-3">${formatCurrency(ad.dailyBudget)}</td><td class="p-3">${formatDate(ad.startDate)} to ${formatDate(ad.endDate)} (${durationDays} days)</td><td class="p-3 font-medium">${formatCurrency(totalCost)}</td><td class="p-3 text-right"><button onclick="openEditAdModal('${ad.adsName}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button></td></tr>`; adsDetailsBody.innerHTML += row; }); } }
        function calculateSummary() { const totalUsd = loadAmounts.reduce((sum, item) => sum + (item.usd || 0), 0); const totalCost = adsDetails.reduce((sum, ad) => { const durationDays = dayjs(ad.endDate).diff(dayjs(ad.startDate), 'day') + 1; return sum + (durationDays > 0 ? durationDays * (ad.dailyBudget || 0) : 0); }, 0); const availableUsd = totalUsd - totalCost; totalUsdEl.textContent = formatCurrency(totalUsd); totalCostEl.textContent = formatCurrency(totalCost); availableUsdEl.textContent = formatCurrency(availableUsd); availableUsdEl.classList.toggle('text-green-600', availableUsd >= 0); availableUsdEl.classList.toggle('text-red-600', availableUsd < 0); }
        function openModal(modalId) { const today = dayjs().format('YYYY-MM-DD'); if (modalId === 'load-modal') document.getElementById('load-date').value = today; if (modalId === 'ad-modal') document.getElementById('start-date').value = today; document.getElementById(modalId).classList.remove('hidden'); };
        function openEditAdModal(adName) { const adToEdit = adsDetails.find(ad => ad.adsName === adName); if (adToEdit) { document.getElementById('edit-ad-name').textContent = adToEdit.adsName; const endDateInput = document.getElementById('edit-end-date'); endDateInput.value = adToEdit.endDate; endDateInput.min = dayjs(adToEdit.endDate).add(1, 'day').format('YYYY-MM-DD'); openModal('edit-ad-modal'); } }
        function updateRateDisplay(rate, isCustom = false, isFallback = false) { let label = 'Live'; if (isCustom) label = 'Custom'; if (isFallback) label = 'Fallback'; rateDisplay.textContent = `${label} Rate: 1 USD = ${parseFloat(rate).toFixed(2)} BDT`; }
        function showNotification(message, isError = true) { const toast = document.getElementById('notification-toast'); const messageEl = document.getElementById('notification-message'); messageEl.textContent = message; toast.classList.remove('bg-red-600', 'bg-green-600'); toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600'); toast.style.right = '20px'; setTimeout(() => { toast.style.right = '-100%'; }, 3000); }
    </script>
</body>
</html>
