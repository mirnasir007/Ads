<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #f9fafb;
        }
        .table-header { background-color: #f3f4f6; }
        .summary-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e5e7eb;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification.error { background-color: #ef4444; }
        .notification.success { background-color: #22c55e; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -20px;
            margin-left: -20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loader-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <div id="app-content" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Ads Management Dashboard</h1>
            <p class="text-gray-500 mt-2">আপনার সকল বিজ্ঞাপন এবং খরচের হিসাব রাখুন</p>
            <div id="rate-display" class="mt-4 text-sm font-semibold p-2 rounded-lg inline-block"></div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="summary-card bg-white p-6 rounded-xl">
                <h3 class="text-gray-500 text-sm font-medium">Total Load Amount</h3>
                <p id="total-load" class="text-2xl font-bold text-gray-800 mt-2">0.00 USD</p>
            </div>
            <div class="summary-card bg-white p-6 rounded-xl">
                <h3 class="text-gray-500 text-sm font-medium">Total Ads Spent</h3>
                <p id="total-spent" class="text-2xl font-bold text-gray-800 mt-2">0.00 USD</p>
            </div>
            <div class="summary-card bg-white p-6 rounded-xl">
                <h3 class="text-gray-500 text-sm font-medium">Remaining Balance</h3>
                <p id="remaining-balance" class="text-2xl font-bold text-green-600 mt-2">0.00 USD</p>
            </div>
            <div class="summary-card bg-white p-6 rounded-xl">
                <h3 class="text-gray-500 text-sm font-medium">Today's Cost (BDT)</h3>
                <p id="today-cost" class="text-2xl font-bold text-gray-800 mt-2">0.00 ৳</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 mb-8">
            <button onclick="openModal('loadModal')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Add Load Amount</button>
            <button onclick="openModal('adModal')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Add New Ad</button>
            <button onclick="exportData()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Export Data</button>
        </div>

        <!-- Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Ads Details Table -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Ads Details</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase table-header">
                            <tr>
                                <th scope="col" class="px-6 py-3">Ad Name</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3">End Date</th>
                                <th scope="col" class="px-6 py-3">Daily Budget</th>
                                <th scope="col" class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ads-table-body"></tbody>
                    </table>
                </div>
            </div>
            <!-- Load Amounts Table -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Load History</h2>
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase table-header sticky top-0">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Recharge (BDT)</th>
                                <th scope="col" class="px-6 py-3">Amount (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="load-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Load Modal -->
    <div id="loadModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Add New Load</h2>
            <form id="loadForm">
                <div class="mb-4">
                    <label for="loadDate" class="block text-gray-700 text-sm font-bold mb-2">Date</label>
                    <input type="date" id="loadDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label for="recharges" class="block text-gray-700 text-sm font-bold mb-2">Recharge Amount (BDT)</label>
                    <input type="number" id="recharges" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="mb-6">
                    <label for="usdAmount" class="block text-gray-700 text-sm font-bold mb-2">Amount in USD (auto-calculated)</label>
                    <input type="number" id="usdAmount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-gray-200" readonly>
                </div>
                <div class="flex items-center justify-end gap-4">
                    <button type="button" onclick="closeModal('loadModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Ad Modal -->
    <div id="adModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Add New Ad</h2>
            <form id="adForm">
                <div class="mb-4">
                    <label for="adsName" class="block text-gray-700 text-sm font-bold mb-2">Ad Name</label>
                    <input type="text" id="adsName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="startDate" class="block text-gray-700 text-sm font-bold mb-2">Start Date</label>
                    <input type="date" id="startDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="endDate" class="block text-gray-700 text-sm font-bold mb-2">End Date</label>
                    <input type="date" id="endDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="mb-6">
                    <label for="dailyBudget" class="block text-gray-700 text-sm font-bold mb-2">Daily Budget (USD)</label>
                    <input type="number" step="0.01" id="dailyBudget" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="flex items-center justify-end gap-4">
                    <button type="button" onclick="closeModal('adModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Ad Modal -->
    <div id="editAdModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-4">Edit Ad End Date</h2>
            <form id="editAdForm">
                <input type="hidden" id="editAdName">
                <div class="mb-4">
                    <p>Ad Name: <strong id="displayAdName"></strong></p>
                </div>
                <div class="mb-6">
                    <label for="newEndDate" class="block text-gray-700 text-sm font-bold mb-2">New End Date</label>
                    <input type="date" id="newEndDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="flex items-center justify-end gap-4">
                    <button type="button" onclick="closeModal('editAdModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification"></div>

    <script>
        // !!! IMPORTANT !!!
        // আপনার Google Apps Script Web App টি Deploy করার পর যে URL টি পাবেন, সেটি এখানে পেস্ট করুন।
        const WEB_APP_URL = 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE';

        // Global variables
        let BDT_PER_USD = 117.00;
        let loadAmounts = [];
        let adsDetails = [];

        // Utility Functions
        const formatDate = (dateStr) => dayjs(dateStr).format('DD MMM, YYYY');
        const showLoader = (show) => {
            const loader = document.getElementById('loader-overlay');
            const content = document.getElementById('app-content');
            if (show) {
                loader.style.display = 'flex';
                content.classList.add('opacity-0');
            } else {
                loader.style.display = 'none';
                content.classList.remove('opacity-0');
            }
        };

        const showNotification = (message, isError = false) => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show ' + (isError ? 'error' : 'success');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        };

        // Modal handling
        const openModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
        };
        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        // Data processing and rendering functions
        const updateRateDisplay = (rate, isLive, isFallback = false) => {
            const display = document.getElementById('rate-display');
            if (isFallback) {
                display.innerHTML = `Live rate unavailable. Using fallback: 1 USD = ${rate.toFixed(2)} BDT`;
                display.className = 'mt-4 text-sm font-semibold p-2 rounded-lg inline-block bg-yellow-100 text-yellow-800';
            } else if (isLive) {
                display.innerHTML = `Live Rate: 1 USD = ${rate.toFixed(2)} BDT`;
                display.className = 'mt-4 text-sm font-semibold p-2 rounded-lg inline-block bg-green-100 text-green-800';
            }
        };

        const renderAll = () => {
            renderSummary();
            renderLoadTable();
            renderAdsTable();
        };

        const renderSummary = () => {
            const today = dayjs().startOf('day');
            const totalLoad = loadAmounts.reduce((sum, item) => sum + item.usd, 0);

            const totalSpent = adsDetails.reduce((sum, ad) => {
                const start = dayjs(ad.startDate);
                const end = dayjs(ad.endDate);
                if (start.isAfter(today) || end.isBefore(start)) return sum;

                const effectiveEnd = today.isAfter(end) ? end : today;
                const duration = effectiveEnd.diff(start, 'day') + 1;
                return sum + (duration * ad.dailyBudget);
            }, 0);

            const todayCost = adsDetails.reduce((sum, ad) => {
                const start = dayjs(ad.startDate);
                const end = dayjs(ad.endDate);
                if (today.isAfter(start.subtract(1, 'day')) && today.isBefore(end.add(1, 'day'))) {
                    return sum + ad.dailyBudget;
                }
                return sum;
            }, 0);

            document.getElementById('total-load').textContent = `${totalLoad.toFixed(2)} USD`;
            document.getElementById('total-spent').textContent = `${totalSpent.toFixed(2)} USD`;
            const remaining = totalLoad - totalSpent;
            document.getElementById('remaining-balance').textContent = `${remaining.toFixed(2)} USD`;
            document.getElementById('remaining-balance').style.color = remaining < 0 ? '#ef4444' : '#16a34a';
            document.getElementById('today-cost').textContent = `${(todayCost * BDT_PER_USD).toFixed(2)} ৳`;
        };


        const renderLoadTable = () => {
            const tbody = document.getElementById('load-table-body');
            tbody.innerHTML = '';
            [...loadAmounts].reverse().forEach(item => {
                const row = `<tr>
                    <td class="px-6 py-4">${formatDate(item.date)}</td>
                    <td class="px-6 py-4">${item.recharges.toFixed(2)}</td>
                    <td class="px-6 py-4">${item.usd.toFixed(2)}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        };

        const renderAdsTable = () => {
            const tbody = document.getElementById('ads-table-body');
            const today = dayjs().startOf('day');
            tbody.innerHTML = '';
            adsDetails.forEach(ad => {
                const end = dayjs(ad.endDate);
                const isActive = today.isBefore(end.add(1, 'day'));
                const statusClass = isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = isActive ? 'Active' : 'Ended';

                const row = `<tr>
                    <td class="px-6 py-4 font-medium text-gray-900">${ad.adsName}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span></td>
                    <td class="px-6 py-4">${formatDate(ad.endDate)}</td>
                    <td class="px-6 py-4">${ad.dailyBudget.toFixed(2)}</td>
                    <td class="px-6 py-4"><button onclick="editAd('${ad.adsName}')" class="font-medium text-blue-600 hover:underline">Edit</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        };

        const editAd = (adName) => {
            const ad = adsDetails.find(a => a.adsName === adName);
            if (ad) {
                document.getElementById('editAdName').value = ad.adsName;
                document.getElementById('displayAdName').textContent = ad.adsName;
                document.getElementById('newEndDate').value = dayjs(ad.endDate).format('YYYY-MM-DD');
                openModal('editAdModal');
            }
        };

        // Server Communication
        const fetchData = async () => {
            if (WEB_APP_URL === 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE') {
                showNotification("Error: Please set your Web App URL in the script.", true);
                showLoader(false);
                return;
            }
            showLoader(true);
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.success) {
                    // Handle Rate Data
                    if (data.rateData.success) {
                        BDT_PER_USD = parseFloat(data.rateData.rate);
                        updateRateDisplay(BDT_PER_USD, true);
                    } else {
                        BDT_PER_USD = parseFloat(data.rateData.fallbackRate);
                        updateRateDisplay(BDT_PER_USD, false, true);
                        showNotification(data.rateData.message, true);
                    }
                    
                    // Handle Sheet Data
                    loadAmounts = data.loadAmounts.map(row => ({ date: row[0], recharges: parseFloat(row[1]) || 0, usd: parseFloat(row[2]) || 0 }));
                    adsDetails = data.adsDetails.map(row => ({ adsName: row[0], startDate: row[1], endDate: row[2], dailyBudget: parseFloat(row[3]) || 0 }));
                    
                    renderAll();
                    showNotification("App is ready!", false);
                } else {
                    throw new Error(data.message || "Failed to fetch initial data.");
                }

            } catch (error) {
                showNotification(`Critical Error: ${error.message}`, true);
            } finally {
                showLoader(false);
            }
        };

        const postData = async (action, data) => {
            showLoader(true);
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for simple POST requests to GAS
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data }),
                    redirect: 'follow'
                });

                // Since no-cors prevents reading the response, we assume success and refetch data
                showNotification("Action submitted. Refreshing data...", false);
                await fetchData(); // Refetch all data to see changes
                
            } catch (error) {
                showNotification(`Error submitting data: ${error.message}`, true);
            } finally {
                showLoader(false);
            }
        };
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', fetchData);

        document.getElementById('recharges').addEventListener('input', (e) => {
            const bdt = parseFloat(e.target.value) || 0;
            document.getElementById('usdAmount').value = (bdt / BDT_PER_USD).toFixed(2);
        });

        document.getElementById('loadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                date: document.getElementById('loadDate').value,
                recharges: parseFloat(document.getElementById('recharges').value),
                usd: parseFloat(document.getElementById('usdAmount').value)
            };
            postData('addLoad', data);
            closeModal('loadModal');
            e.target.reset();
        });

        document.getElementById('adForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                adsName: document.getElementById('adsName').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                dailyBudget: parseFloat(document.getElementById('dailyBudget').value)
            };
            postData('addAd', data);
            closeModal('adModal');
            e.target.reset();
        });

        document.getElementById('editAdForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                adsName: document.getElementById('editAdName').value,
                newEndDate: document.getElementById('newEndDate').value
            };
            postData('editAd', data);
            closeModal('editAdModal');
            e.target.reset();
        });

        // Export functionality
        const exportData = () => {
            const wb = XLSX.utils.book_new();
            const ws1_data = [
                ["Ad Name", "Start Date", "End Date", "Daily Budget (USD)"],
                ...adsDetails.map(ad => [ad.adsName, formatDate(ad.startDate), formatDate(ad.endDate), ad.dailyBudget])
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(ws1_data);
            XLSX.utils.book_append_sheet(wb, ws1, "Ads Details");

            const ws2_data = [
                ["Date", "Recharge (BDT)", "Amount (USD)"],
                ...loadAmounts.map(l => [formatDate(l.date), l.recharges, l.usd])
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(ws2_data);
            XLSX.utils.book_append_sheet(wb, ws2, "Load Amounts");

            XLSX.writeFile(wb, "Ads_Dashboard_Export.xlsx");
            showNotification("Data exported successfully!", false);
        };
    </script>
</body>
</html>
